# Step 1: Use an official Python runtime as a parent image (minimal, secure version)
FROM python:3.13-alpine AS base

# Step 2: Set environment variables to improve security and performance
ENV PYTHONUNBUFFERED=1 \
    APP_VERSION=1.0.0 \
    PORT=5000 \
    GUNICORN_CMD_ARGS="--workers=3 --bind=0.0.0.0:5000"

# Step 3: Set a working directory
WORKDIR /app

# Step 4: Copy and install dependencies separately to leverage Docker caching
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Step 5: Copy the application code into the container
COPY app.py .

# Step 6: Create a non-root user and set proper permissions
RUN addgroup -S appgroup && adduser -S appuser -G appgroup && \
    chown -R appuser:appgroup /app

# Step 7: Switch to the non-root user
USER appuser

# Step 8: Expose the required port
EXPOSE 5000

# Step 9: Define the command to run the application securely
CMD ["gunicorn", "app:app"]
